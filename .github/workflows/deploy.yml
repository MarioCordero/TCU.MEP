name: Integrar ChemMaster a SPECT (Padre)

on:
  workflow_dispatch: # Se activa solo cuando oprimes el botón en Actions

jobs:
  sync-to-parent:
    runs-on: ubuntu-latest
    steps:
      # 1. Descargar el código del HIJO (Fuente)
      - name: Checkout Child Repo (TCU.MEP)
        uses: actions/checkout@v4
        with:
          path: child-repo

      # 2. Descargar el código del PADRE (Destino)
      - name: Checkout Parent Repo (SPECT)
        uses: actions/checkout@v4
        with:
          repository: TU_USUARIO/NOMBRE_REPO_PADRE # <--- CAMBIA ESTO (ej: mario/spectcr-web)
          token: ${{ secrets.PAT_TOKEN }}
          path: parent-repo
          ref: main # O la rama que uses en el padre

      # 3. Sincronizar BACKEND (API)
      # Copia API/ChemMaster del hijo a API/ChemMaster del padre
      - name: Sync Backend (API)
        run: |
          echo "Sincronizando API PHP..."
          # -a: archive (mantiene permisos/fechas), -v: verbose, --delete: borra en destino lo que no exista en origen
          rsync -av --delete --exclude 'Config/development.ini' child-repo/API/ChemMaster/ parent-repo/API/ChemMaster/

      # 4. Sincronizar FRONTEND (Carpetas Clave)
      # Copiamos solo las carpetas internas. NO copiamos main.tsx ni index.html
      # para no romper el punto de entrada del padre (ChemMaster.tsx).
      - name: Sync Frontend Directories
        run: |
          echo "Sincronizando Frontend React..."
          
          # Definir ruta base destino
          DEST_BASE="parent-repo/SPECT-Website/src/ChemMaster"
          
          # Lista de carpetas a sincronizar
          # Nota: Agregué 'hooks' y 'lib' basándome en tu estructura
          FOLDERS=("assets" "components" "config" "hooks" "lib" "pages" "screens" "types")

          for folder in "${folders[@]}"; do
            src="child-repo/chemmaster-app/src/$folder/"
            dest="$DEST_BASE/$folder/"
            
            # Si la carpeta existe en el origen, sincronizarla
            if [ -d "$src" ]; then
              mkdir -p "$dest"
              rsync -av --delete "$src" "$dest"
            fi
          done

      # 5. Guardar cambios en el PADRE
      - name: Commit and Push to Parent
        run: |
          cd parent-repo
          git config user.name "GitHub Action Bot"
          git config user.email "actions@github.com"
          
          # Verificamos si hay cambios antes de hacer commit
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "feat(integration): Actualización automática desde ChemMaster App (Hijo)"
            git push origin main # O la rama que uses
            echo "✅ Cambios subidos correctamente al Padre"
          else
            echo "✨ No hubo cambios necesarios, todo está sincronizado."
          fi