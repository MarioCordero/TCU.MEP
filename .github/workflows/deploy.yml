name: Integrar ChemMaster a SPECT

on:
  workflow_dispatch: # Se activa manualmente con el bot√≥n en Actions

jobs:
  sync-to-parent:
    runs-on: ubuntu-latest
    steps:
      # 1. Descargar el c√≥digo del HIJO (Fuente)
      - name: Checkout Child Repo (TCU.MEP)
        uses: actions/checkout@v4
        with:
          path: child-repo

      # 2. Descargar el c√≥digo del PADRE (Destino)
      - name: Checkout Parent Repo (SPECT)
        uses: actions/checkout@v4
        with:
          repository: spectcr/spectcr.com
          token: ${{ secrets.DEPLOY_TOKEN }}  # <--- ¬°AQU√ç EST√Å EL CAMBIO!
          path: parent-repo
          ref: main

      # 3. Sincronizar BACKEND (API)
      - name: Sync Backend (API)
        run: |
          echo "üß™ Sincronizando API PHP..."
          # -a: archive, -v: verbose, --delete: borra en destino lo que no exista en origen
          rsync -av --delete --exclude 'Config/development.ini' child-repo/API/ChemMaster/ parent-repo/API/ChemMaster/

      # 4. Sincronizar FRONTEND (Carpetas Clave)
      - name: Sync Frontend Directories
        run: |
          echo "‚öõÔ∏è Sincronizando Frontend React..."
          
          # Ruta base en el padre
          DEST_BASE="parent-repo/SPECT-Website/src/ChemMaster"
          
          # Lista de carpetas a copiar
          FOLDERS=("assets" "components" "config" "hooks" "lib" "pages" "screens" "types")

          for folder in "${FOLDERS[@]}"; do
            src="child-repo/chemmaster-app/src/$folder/"
            dest="$DEST_BASE/$folder/"
            
            # Verificamos si la carpeta existe en el hijo antes de copiar
            if [ -d "$src" ]; then
              echo "‚úÖ Procesando: $folder"
              mkdir -p "$dest"
              rsync -av --delete "$src" "$dest"
            else
              echo "‚ö†Ô∏è Saltando: $folder (No existe en el origen)"
            fi
          done

      # 5. Guardar cambios en el PADRE
      - name: Commit and Push to Parent
        run: |
          cd parent-repo
          
          # Configurar identidad del bot para este commit
          git config user.name "ChemMaster Bot"
          git config user.email "bot@spectcr.com"
          
          # Verificar si hubo cambios reales
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "feat(integration): Actualizaci√≥n autom√°tica desde ChemMaster App"
            git push origin main
            echo "üöÄ √âXITO: Cambios subidos correctamente al repositorio Padre."
          else
            echo "‚ú® NADA QUE HACER: Todo est√° sincronizado."
          fi